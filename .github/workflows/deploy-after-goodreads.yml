name: Deploy after Goodreads update

on:
  workflow_run:
    workflows: ["Update Goodreads Reading"]
    types: [completed]

permissions:
  contents: write
  actions: write

jobs:
  deploy-if-data-changed:
    # Only run if the Goodreads workflow succeeded and actually made changes
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout üõéÔ∏è
        uses: actions/checkout@v4
        with:
          # Fetch the latest changes including the Goodreads update
          fetch-depth: 0
      
      - name: Check if Goodreads data was updated
        id: check_changes
        run: |
          # Get the latest commit from the Goodreads workflow
          latest_commit=$(git log --oneline -1 --author="GitHub Action" --grep="Update Goodreads reading data" --format="%H")
          if [[ -n "$latest_commit" ]]; then
            # Check if the commit modified the Goodreads data file
            if git diff --name-only $latest_commit~1 $latest_commit | grep -q "_data/goodreads-reading.json"; then
              echo "goodreads_updated=true" >> $GITHUB_OUTPUT
              echo "‚úÖ Goodreads data was updated in commit $latest_commit"
            else
              echo "goodreads_updated=false" >> $GITHUB_OUTPUT
              echo "‚ÑπÔ∏è No Goodreads data changes found"
            fi
          else
            echo "goodreads_updated=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No recent Goodreads update commits found"
          fi
      
      - name: Trigger deployment
        if: steps.check_changes.outputs.goodreads_updated == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const result = await github.rest.actions.createWorkflowDispatch({
              owner: context.repo.owner,
              repo: context.repo.repo,
              workflow_id: 'deploy.yml',
              ref: 'main'
            });
            console.log('‚úÖ Deployment workflow triggered successfully');
      
      - name: Skip deployment
        if: steps.check_changes.outputs.goodreads_updated != 'true'
        run: |
          echo "‚è≠Ô∏è Skipping deployment - no Goodreads data changes detected"
